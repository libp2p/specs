<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="935px" preserveAspectRatio="none" style="width:854px;height:935px;background:#FFFFFF;" version="1.1" viewBox="0 0 854 935" width="854px" zoomAndPan="magnify"><defs><filter height="300%" id="f1dn30vbmi1ncj" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="157" y1="53.4883" y2="264.6621"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="157" x2="157" y1="264.6621" y2="305.6172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="157" y1="305.6172" y2="877.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="690" x2="690" y1="53.4883" y2="264.6621"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="690" x2="690" y1="264.6621" y2="305.6172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="690" x2="690" y1="305.6172" y2="877.8281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="127" y="50.5352">Initiator</text><ellipse cx="157" cy="21" fill="#FEFECE" filter="url(#f1dn30vbmi1ncj)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="145" x2="169" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="127" y="890.3633">Initiator</text><ellipse cx="157" cy="909.3164" fill="#FEFECE" filter="url(#f1dn30vbmi1ncj)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="145" x2="169" y1="923.3164" y2="923.3164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="650" y="50.5352">Responder</text><ellipse cx="690" cy="21" fill="#FEFECE" filter="url(#f1dn30vbmi1ncj)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="678" x2="702" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="650" y="890.3633">Responder</text><ellipse cx="690" cy="909.3164" fill="#FEFECE" filter="url(#f1dn30vbmi1ncj)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="678" x2="702" y1="923.3164" y2="923.3164"/><path d="M124,68.4883 L124,108.4883 L722,108.4883 L722,78.4883 L712,68.4883 L124,68.4883 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,68.4883 L712,78.4883 L722,78.4883 L712,68.4883 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="315" x="259" y="86.0566">Assume both sides understand stream-migration.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="259" y="101.3672">Also Assume Initiator has the lower peer ID.</text><polygon fill="#A80036" points="678,135.4199,688,139.4199,678,143.4199,682,139.4199" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="139.4199" y2="139.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="370" y="134.6777">Open connection</text><polygon fill="#A80036" points="678,164.7305,688,168.7305,678,172.7305,682,168.7305" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="168.7305" y2="168.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="344" y="163.9883">Open multiplexed stream</text><polygon fill="#A80036" points="678,194.041,688,198.041,678,202.041,682,198.041" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="198.041" y2="198.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="169" y="193.2988">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="438" y="192.9751">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="678,223.3516,688,227.3516,678,231.3516,682,227.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="227.3516" y2="227.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="245" y="222.6094">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="264" x="279" y="222.2856">StreamMigration(type=Label(id=0))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="547" y="222.6094">message</text><polygon fill="#A80036" points="678,252.6621,688,256.6621,678,260.6621,682,256.6621" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="256.6621" y2="256.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="259" x="294" y="251.9199">continue negotiating underlying protocol</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="337.5" y="289.2969"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="172" x="337.5" y="289.2969">Nodes use the stream as normal</text><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="0" x="512.5" y="289.2969"/><rect fill="#EEEEEE" filter="url(#f1dn30vbmi1ncj)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="847" x="0" y="326.2725"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="847" y1="326.2725" y2="326.2725"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="847" y1="329.2725" y2="329.2725"/><rect fill="#EEEEEE" filter="url(#f1dn30vbmi1ncj)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="134" x="356.5" y="315.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="362.5" y="332.1855">Stream Migration</text><path d="M124,353.9277 L124,378.9277 L722,378.9277 L722,363.9277 L712,353.9277 L124,353.9277 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,353.9277 L712,363.9277 L722,363.9277 L712,353.9277 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="320.5" y="371.4961">Migrate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="371.5" y="371.4961">Stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="435.5" y="371.4961">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="452.5" y="371.4961">Stream 2</text><polygon fill="#A80036" points="678,405.5488,688,409.5488,678,413.5488,682,409.5488" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="409.5488" y2="409.5488"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="369" y="404.8066">Open new stream</text><polygon fill="#A80036" points="678,434.8594,688,438.8594,678,442.8594,682,438.8594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="438.8594" y2="438.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="169" y="434.1172">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="438" y="433.7935">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="678,464.1699,688,468.1699,678,472.1699,682,468.1699" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="468.1699" y2="468.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="171.5" y="463.4277">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="238.5" y="463.4277">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="272.5" y="463.104">StreamMigration(type=Migrate(id=2, from=0))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="620.5" y="463.4277">message</text><polygon fill="#A80036" points="168,493.4805,158,497.4805,168,501.4805,164,497.4805" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="162" x2="689" y1="497.4805" y2="497.4805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="308" y="492.7383">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="375" y="492.7383">Send AckMigrate message</text><path d="M538,510.4805 L538,550.4805 L838,550.4805 L838,520.4805 L828,510.4805 L538,510.4805 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M828,510.4805 L828,520.4805 L838,520.4805 L828,510.4805 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="544" y="528.0488">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="606" y="527.7251">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="634" y="528.0488">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="654" y="528.0488">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="718" y="528.0488">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="544" y="543.3594">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="763" y="543.3594">stream 2</text><path d="M15,565.1016 L15,605.1016 L294,605.1016 L294,575.1016 L284,565.1016 L15,565.1016 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M284,565.1016 L284,575.1016 L294,575.1016 L284,565.1016 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="21" y="582.6699">Close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="60" y="582.6699">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="124" y="582.6699">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="21" y="597.9805">Will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="131" y="597.9805">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="195" y="597.9805">from now on.</text><polygon fill="#A80036" points="678,632.0332,688,636.0332,678,640.0332,682,636.0332" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="636.0332" y2="636.0332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="378" y="631.291">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="445" y="631.291"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="445" y="630.9673">EOF</text><path d="M542,649.0332 L542,704.0332 L833,704.0332 L833,659.0332 L823,649.0332 L542,649.0332 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M823,649.0332 L823,659.0332 L833,659.0332 L823,649.0332 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="548" y="666.6016">When</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="66" x="586" y="666.6016">Responder</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="656" y="666.6016">reads</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="694" y="666.2778">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="722" y="666.6016">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="742" y="666.6016">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="548" y="681.9121">it will close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="624" y="681.9121">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="688" y="681.9121">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="548" y="697.2227">It will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="670" y="697.2227">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="734" y="697.2227">from now on.</text><polygon fill="#A80036" points="168,731.2754,158,735.2754,168,739.2754,164,735.2754" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="162" x2="689" y1="735.2754" y2="735.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="378" y="730.5332">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="445" y="730.5332"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="445" y="730.2095">EOF</text><path d="M5,748.2754 L5,788.2754 L305,788.2754 L305,758.2754 L295,748.2754 L5,748.2754 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M295,748.2754 L295,758.2754 L305,758.2754 L295,748.2754 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="11" y="765.8438">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="73" y="765.52">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="101" y="765.8438">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="121" y="765.8438">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="185" y="765.8438">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="11" y="781.1543">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="230" y="781.1543">stream 2</text><path d="M124,802.8965 L124,857.8965 L722,857.8965 L722,812.8965 L712,802.8965 L124,802.8965 " fill="#FBFB77" filter="url(#f1dn30vbmi1ncj)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,802.8965 L712,812.8965 L722,812.8965 L712,802.8965 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="266.5" y="820.4648">At this point</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="349.5" y="820.4648">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="413.5" y="820.4648">is closed for writing on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="266.5" y="835.7754">both sides, and both sides have read up to</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="538.5" y="835.4517">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="562.5" y="835.7754">.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="266.5" y="851.0859">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="330.5" y="851.0859">has been fully migrated to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="499.5" y="851.0859">stream 2</text><!--MD5=[ce0bddd3c88c08bfd90863374b5d991d]
@startuml stream-migration
skinparam sequenceMessageAlign center
entity Initiator
entity Responder

note over Initiator, Responder
    Assume both sides understand stream-migration.
    Also Assume Initiator has the lower peer ID.
end note

Initiator -> Responder: Open connection
Initiator -> Responder: Open multiplexed stream

Initiator -> Responder: Negotiate stream-migration protocol with ""<stream-migration protocol id>""

Initiator -> Responder: Send ""StreamMigration(type=Label(id=0))"" message

Initiator -> Responder: <i> continue negotiating underlying protocol </i>
... <i>Nodes use the stream as normal<i> ...

== Stream Migration ==

note over Initiator, Responder: Migrate <b>Stream 0</b> to <b>Stream 2</b>

Initiator -> Responder: Open new stream
Initiator -> Responder: Negotiate stream-migration protocol with ""<stream-migration protocol id>""

Initiator -> Responder: <b>Stream 2:</b> Send ""StreamMigration(type=Migrate(id=2, from=0))"" message

Initiator <- Responder: <b>Stream 2:</b> Send AckMigrate message

note over Responder
    Treat any ""EOF"" on <b>stream 0</b> as a signal
    that it should continue reading on <b>stream 2</b>
end note


note over Initiator
    Close <b>stream 0</b> for writing.
    Will only write to <b>stream 2</b> from now on.
end note

Initiator -> Responder: <b>Stream 2:</b> ""EOF""

note over Responder
    When <i>Responder</i> reads ""EOF"" on <b>stream 0</b>
    it will close <b>stream 0</b> for writing.
    It will only write to <b>stream 2</b> from now on.
end note

Initiator <- Responder: <b>Stream 2:</b> ""EOF""

note over Initiator
    Treat any ""EOF"" on <b>stream 0</b> as a signal
    that it should continue reading on <b>stream 2</b>
end note

note over Initiator, Responder
    At this point <b>stream 0</b> is closed for writing on
    both sides, and both sides have read up to ""EOF"".
    <b>stream 0</b> has been fully migrated to <b>stream 2</b>
end note

@enduml

PlantUML version 1.2021.12(Tue Oct 05 18:01:58 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>